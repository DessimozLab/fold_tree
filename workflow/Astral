
#once snakemake is installed use the following command to test the struct tree
import snakemake.utils
snakemake.utils.min_version("7.8.0")
snake_dir = workflow.basedir

rootdir = ''.join([ sub + '/' for sub in snake_dir.split('/')[:-1] ] )

#glob wildcards for all OGs using directory flag 
folder = glob_wildcards("{folder}/identifiers.txt").folder
outdir = config["outfolder"]
astralpath = config["astral_path"]
mattypes = ['foldtree', 'alntmscore', 'lddt']
configfile: rootdir+ "workflow/config/config_vars.yaml"

# remote homologues search parameters
foldseekpath = config["foldseek_path"]
outfolder = config["outfolder"]
current_dir = os.getcwd()

if foldseekpath == 'provided':
	foldseekpath = rootdir + "foldseek/foldseek"

rule all:
	input:
		expand( "{folder}/plddt.json" , folder = folder ) ,
		expand("{folder}/struct_tree.PP.nwk.rooted.swapped", folder = folder),
		outfolder+"astral_tree_foldtree.nwk", 
		outfolder+"concatenated_tree.nwk"

rule concatenate_trees:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		expand("{folder}/struct_tree.PP.nwk.rooted.swapped", folder=folder)
	output:
		"{outfolder}/concatenated_tree.nwk" 
	log:
		"{outfolder}/logs/concatenate_trees.log" 
	shell:
		#'../src/concatenate_trees.py'
		"cat {current_dir}/**/struct_tree.PP.nwk.rooted > {outfolder}/concatenated_tree.nwk"

rule astral_foldtree:
	conda: 
		"astral"
	input:
		"{outfolder}/concatenated_tree.nwk"
	output:
		"{outfolder}/astral_tree_foldtree.nwk"
	log:
		"{outfolder}/logs/astral_foldtree.log"
	shell:
		"astral -i {outfolder}/concatenated_tree.nwk -o {outfolder}/astral_tree_foldtree.nwk"

rule swaplabels:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/struct_tree.PP.nwk.rooted"
	output:
		"{folder}/struct_tree.PP.nwk.rooted.swapped"
	log:
		"{folder}/logs/swaplabels.log"
	script:
		'../src/swaplabels.py'


rule mad_root_struct:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"		
	input:
	   "{folder}/struct_tree.PP.nwk"
	output:
	   "{folder}/struct_tree.PP.nwk.rooted"
	log:
		"{folder}/logs/struct_madroot.log"
	params:
		cmd = lambda w: rootdir+'madroot/mad {}/struct_tree.PP.nwk'.format(w.folder,w.folder),
		check_empty = lambda w: os.path.getsize(w.folder+'/struct_tree.PP.nwk') > 0
	script:
		"../src/runsub.py"

rule postprocess:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/struct_tree.nwk"
	output:
		"{folder}/struct_tree.PP.nwk"
	log:
		"{folder}/logs/struct_postprocess.log"
	script:
		'../src/postprocess.py'

rule quicktree:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"		
	input:
		"{folder}/foldtree_fastmemat.txt"
	output:
		"{folder}/struct_tree.nwk"
	params:
		cmd = lambda w: "quicktree -i m {}/foldtree_fastmemat.txt > {}/struct_tree.nwk".format(w.folder,w.folder),
		check_empty = lambda w: os.path.getsize(w.folder+'/foldtree_fastmemat.txt') > 0
	script:
		"../src/runsub.py"

rule foldseek2distmat:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/allvall_1.csv"
	output:
		"{folder}/foldtree_fastmemat.txt",
		"{folder}/alntmscore_fastmemat.txt",
		"{folder}/lddt_fastmemat.txt",
	log:
		"{folder}/logs/foldseek2distmat.log"
	script:
		"../src/foldseekres2distmat_simple.py"

rule foldseek_allvall_1:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/finalset.csv"
	output:
		"{folder}/allvall_1.csv"
	log:
		"{folder}/logs/foldseekallvall.log"
	shell:
		foldseekpath + " easy-search {wildcards.folder}/structs/ {wildcards.folder}/structs/ {wildcards.folder}/allvall_1.csv {wildcards.folder}/tmp --format-output 'query,target,fident,alnlen,mismatch,gapopen,qstart,qend,tstart,tend,evalue,bits,lddt,lddtfull,alntmscore' --exhaustive-search --alignment-type 2 -e inf" 

rule dl_ids_sequences:
	conda: 
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		ids="{folder}/identifiers.txt",
	output:
		"{folder}/sequence_dataset.csv",
	log:
		"{folder}/logs/dlsequences.log"
	params:
		custom_structs=False
	script:
		"../src/dl_sequences.py"

rule plddt:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/finalset.csv",
	output:
		"{folder}/plddt.json",
	log:
		"{folder}/logs/plddt.log"
	script:
		'../src/grabplddt.py'

rule dl_ids_structs:
	conda:
		#"config/fold_tree.yaml"
		"foldtree"
	input:
		"{folder}/sequence_dataset.csv",
	output:
		"{folder}/sequences.fst",
		"{folder}/finalset.csv",
	log:
		"{folder}/logs/dlstructs.log",
	params:
		filtervar=config["filter"],
		filtervar_min=config["filter_min"],
		filtervar_avg=config["filter_avg"],
		custom_structs=config["custom_structs"],
	script:
		"../src/dl_structs.py"
